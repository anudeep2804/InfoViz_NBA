<!DOCTYPE html>
<html>

<head>
    <title>GOAT Debate</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>

<body>
    <script>
        d3.csv("archive-4/Seasons_Stats.csv").then(data => {
            // Preprocessing: removing unnecessary columns
            data.forEach(d => {
                delete d.Pos;
                delete d.Age;
                delete d.Tm;
                delete d.GS;
                delete d.MP;
                delete d.blanl;
                delete d.blank2;
            });

            // Group the players
            const groupedPlayers = new Map();
            data.forEach(d => {
                const playerName = d.Player;
                if (groupedPlayers.has(playerName)) {
                    groupedPlayers.get(playerName).push(d);
                } else {
                    groupedPlayers.set(playerName, [d]);
                }
            });

            // Remove players with fewer than 10 seasons
            groupedPlayers.forEach((value, key) => {
                if (value.length < 10) {
                    groupedPlayers.delete(key);
                }
            });

            // Remove players with any null attribute values
            groupedPlayers.forEach((seasons, playerName) => {
                for (const season of seasons) {
                    let hasNullValue = false;
                    for (const attribute in season) {
                        if (season[attribute] === null || season[attribute] === "") {
                            hasNullValue = true;
                            break;
                        }
                    }
                    if (hasNullValue) {
                        groupedPlayers.delete(playerName);
                        break;
                    }
                }
            });


            // Create a new map to store the calculated attribute sums
            const playerAttributeSums = new Map();

            groupedPlayers.forEach((seasons, playerName) => {
                let attributeSums = {
                    PTS: 0,
                    TRB: 0,
                    AST: 0,
                    STL: 0,
                    BLK: 0,
                    TOV: 0
                };

                seasons.forEach(season => {
                    const gamesPlayed = parseFloat(season.G);
                    attributeSums.TRB += parseFloat(season.TRB) / gamesPlayed;
                    attributeSums.AST += parseFloat(season.AST) / gamesPlayed;
                    attributeSums.STL += parseFloat(season.STL) / gamesPlayed;
                    attributeSums.BLK += parseFloat(season.BLK) / gamesPlayed;
                    attributeSums.TOV += parseFloat(season.TOV) / gamesPlayed;
                    attributeSums.PTS += parseFloat(season.PTS) / gamesPlayed;
                });

                // Divide the attribute sums by the number of seasons
                const numSeasons = seasons.length;
                attributeSums.TRB /= numSeasons;
                attributeSums.AST /= numSeasons;
                attributeSums.STL /= numSeasons;
                attributeSums.BLK /= numSeasons;
                attributeSums.TOV /= numSeasons;
                attributeSums.PTS /= numSeasons;

                // Add the calculated sums to the new map
                playerAttributeSums.set(playerName, attributeSums);
            });

            
            // Helper function to get the top N players for each attribute
            function getTopNPlayers(players, attribute, n) {
                return [...players.entries()]
                    .sort((a, b) => b[1][attribute] - a[1][attribute])
                    .slice(0, n)
                    .map(([playerName, attributes]) => ({ name: playerName, value: attributes[attribute] }));
            }


            // Convert the playerAttributeSums map into a hierarchical JSON object
            // Convert the playerAttributeSums map into a hierarchical JSON object with top 40 players for each attribute
            const hierarchyData = {
                name: "attributes",
                children: [
                    { name: "PTS", children: getTopNPlayers(playerAttributeSums, "PTS", 40) },
                    { name: "TRB", children: getTopNPlayers(playerAttributeSums, "TRB", 40) },
                    { name: "AST", children: getTopNPlayers(playerAttributeSums, "AST", 40) },
                    { name: "STL", children: getTopNPlayers(playerAttributeSums, "STL", 40) },
                    { name: "BLK", children: getTopNPlayers(playerAttributeSums, "BLK", 40) },
                    { name: "TOV", children: getTopNPlayers(playerAttributeSums, "TOV", 40) }
                ],
            };




            // Log the hierarchical JSON object
            console.log(hierarchyData);


            // Set the dimensions and margins of the treemap
            const width = 1000;
            const height = 600;
            const margin = { top: 10, right: 10, bottom: 10, left: 10 };

            

            // Create the treemap layout
            const treemapLayout = d3.treemap()
                .size([width, height])
                .padding(2);

            // Create the root of the treemap
            const root = d3.hierarchy(hierarchyData)
                .sum(d => d.value)
                .sort((a, b) => b.value - a.value)


            // Tree map definition
            treemapLayout(root);

            // svg element for each player and attribute
            const svg = d3.select("body")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Draw the rectangles for each player and attribute
            const leaf = svg.selectAll("g")
                .data(root.leaves())
                .enter()
                .append("g")
                .attr("transform", d => `translate(${d.x0},${d.y0})`);

            leaf.append("rect")
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .attr("fill", d => d3.schemeSet2[d.depth - 1]);

            // Add player names to the tiles
            leaf.append("text")
                .attr("x", 3)
                .attr("y", 12)
                .text(d => d.data.name)
                .attr("font-size", "10px")
                .attr("fill", "white");


        });
    </script>
</body>

</html>